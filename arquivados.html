<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>OS Arquivadas — Irmãos Hartmann</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --border:#2c3448; --green:#10f7a0; --orange:#f59e0b; --blue:#0ea5e9;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif}
  .wrap{max-width:760px;margin:0 auto;padding:20px}
  .topbar{display:flex;justify-content:flex-end;margin-bottom:8px}
  .link-top{font-size:14px;color:#9bd3ff;text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid var(--border)}
  .title{font-weight:800;font-size:20px;margin:6px 0 14px}
  .card{background:var(--card);border-radius:18px;padding:18px;box-shadow:0 16px 40px rgba(0,0,0,.45);margin-bottom:16px}
  .rowBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{
    display:flex;align-items:center;justify-content:center;height:44px;padding:0 16px;border-radius:12px;
    font-weight:800;font-size:16px;border:0;cursor:pointer;user-select:none
  }
  .btn-green{background:var(--green);color:#001c14}
  .btn-orange{background:var(--orange);color:#1f1300}
  .btn-outline{background:transparent;color:var(--text);border:2px solid var(--border)}
  .muted{color:var(--muted);font-size:12px;margin:8px 0 6px}
  /* Prévia igual ao vendas.html (sem borda, largura do card, fonte mono) */
  .preview{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.2;
    margin: 6px 0 0;
    color: var(--text);
    width: 100%;
    background: transparent;
    padding: 0;
    border: 0;
  }
  .empty{color:var(--muted);text-align:center;border:1px dashed var(--border);padding:20px;border-radius:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="link-top" href="menu.html">Voltar ao menu</a>
    </div>

    <div class="title">OS Arquivadas</div>

    <div id="lista"></div>
  </div>

<script>
  const $ = s => document.querySelector(s);

  function normalizeText(t){
    // Garante que sequências "\n" virem quebras reais
    return String(t || '')
      .replace(/\r\n/g, '\n')
      .replace(/\r/g, '\n')
      .replace(/\\n/g, '\n');
  }

  function carregar(){
    let list = [];
    try { list = JSON.parse(localStorage.getItem('os_arquivadas') || '[]'); } catch(e){ list = []; }

    const cont = $('#lista');
    cont.innerHTML = '';

    if (!list.length){
      cont.innerHTML = '<div class="empty">Nenhuma OS arquivada ainda.</div>';
      return;
    }

    // Mostra mais recente primeiro
    list
      .map((x,i)=>({idx:i, ...x}))
      .sort((a,b)=> b.createdAt - a.createdAt)
      .forEach(item=>{
        const card = document.createElement('div');
        card.className = 'card';

        // Cabeçalho simples com data/cliente (se existirem)
        const quando = item.createdAt ? new Date(item.createdAt) : null;
        const cab = document.createElement('div');
        cab.className = 'muted';
        cab.textContent =
          (quando ? `Salvo: ${quando.toLocaleDateString()} ${quando.toLocaleTimeString().slice(0,5)} • ` : '') +
          (item.cliente ? `Cliente: ${item.cliente.toUpperCase()}` : '');
        card.appendChild(cab);

        // Pré-visualização (igual do vendas.html)
        const pre = document.createElement('pre');
        pre.className = 'preview';
        pre.textContent = normalizeText(item.texto); // <<< sem "\n" literal
        card.appendChild(pre);

        // Botões
        const row = document.createElement('div');
        row.className = 'rowBtns';

        const btnPrint = document.createElement('button');
        btnPrint.className = 'btn btn-green';
        btnPrint.textContent = 'Imprimir';
        btnPrint.onclick = async ()=>{
          const texto = normalizeText(item.texto);
          if (navigator.share){
            try{ await navigator.share({ text: texto, title: 'OS Hartmann' }); }catch(e){}
          }else{
            try{ await navigator.clipboard.writeText(texto); alert('OS copiada! Abra o app da impressora e cole.'); }
            catch(e){ alert('Não foi possível copiar. Selecione o texto manualmente.'); }
          }
        };
        row.appendChild(btnPrint);

        const btnDel = document.createElement('button');
        btnDel.className = 'btn btn-orange';
        btnDel.textContent = 'Excluir';
        btnDel.onclick = ()=>{
          if (!confirm('Remover esta OS arquivada?')) return;
          let all = JSON.parse(localStorage.getItem('os_arquivadas') || '[]');
          all.splice(item.idx, 1);
          localStorage.setItem('os_arquivadas', JSON.stringify(all));
          carregar();
        };
        row.appendChild(btnDel);

        card.appendChild(row);

        cont.appendChild(card);
      });
  }

  carregar();
</script>
</body>
</html>
