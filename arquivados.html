<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>OS Arquivadas — Irmãos Hartmann</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0ea5e9">
<link rel="apple-touch-icon" href="img/icon-192.png">

<style>
  :root{
    --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --border:#2c3448; --green:#10f7a0; --orange:#f59e0b; --blue:#0ea5e9; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif}
  .wrap{max-width:860px;margin:0 auto;padding:14px 20px 20px}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .topbar a{font-size:13px;color:#93c5fd;text-decoration:none;padding:6px 10px;border:1px solid var(--border);border-radius:10px}
  .topbar a:active{transform:translateY(1px)}
  .title{font-weight:800;font-size:18px}

  .card{background:var(--card);border-radius:18px;padding:16px;box-shadow:0 16px 40px rgba(0,0,0,.45)}
  .list{display:flex;flex-direction:column;gap:10px}
  .row{
    display:flex;gap:10px;align-items:center;justify-content:space-between;
    padding:12px;border:1px solid var(--border);border-radius:12px;background:#0b1220; cursor:pointer;
  }
  .row:hover{background:#0e1424}
  .meta{display:flex;flex-direction:column;gap:4px}
  .meta b{font-size:16px}
  .muted{color:var(--muted);font-size:12px}
  .sum{font-weight:800}

  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000;
  }
  .modal{
    width:100%; max-width:900px; background:#0b1220; border:1px solid var(--border); border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.5); padding:16px; max-height:90vh; overflow:auto;
  }
  .modal h3{margin:0 0 8px; font-size:18px}
  .modal .actions{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;height:40px;border-radius:10px;
    border:0;padding:0 12px;font-weight:800;cursor:pointer
  }
  .btn-green{background:var(--green);color:#001c14}
  .btn-blue{background:var(--blue);color:#001018}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn-danger{background:var(--danger);color:#fff}
  .close-x{margin-left:auto}
  .hr{height:1px;background:var(--border);margin:12px 0}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-top:4px}
  input,select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
    background:#0b1220;color:var(--text);margin-top:6px;text-transform:uppercase;
  }
  textarea{min-height:60px}
  .itemRow{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-top:1px solid var(--border)}
  .itemRow:first-child{border-top:0}
  .itemInfo{font-size:14px;color:#cbd5e1}
  .itemInfo b{color:#e5e7eb}

  .preview{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space: pre-wrap; word-break: break-word; line-height: 1.2;
    margin: 6px 0 0; color: var(--text); width: 100%; background: transparent; padding: 0; border: 0;
  }
</style>
</head>
<body>

<!-- Banner de instalação PWA -->
<div id="install-bar" style="
  position:sticky;top:0;z-index:50;display:none;align-items:center;justify-content:space-between;gap:10px;
  background:#0b1220;border-bottom:1px solid var(--border);padding:10px 14px;font-family:system-ui,Arial,sans-serif;color:#e5e7eb;">
  <div>Instale o app <b>Irmãos Hartmann</b> no seu celular</div>
  <button onclick="instalarApp()" style="background:#0ea5e9;color:#001018;border:0;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer">Instalar</button>
</div>
<div id="ios-tip" style="display:none;color:#9ca3af;font-size:13px;margin:10px 14px 0;font-family:system-ui,Arial,sans-serif">
  No iPhone: toque em <b>Compartilhar</b> → <b>Adicionar à Tela de Início</b> para instalar.
</div>

<div class="wrap">
  <div class="topbar">
    <div class="title">OS Arquivadas</div>
    <a href="menu.html">Voltar ao menu</a>
  </div>

  <div class="card">
    <div id="list" class="list"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-backdrop" id="modal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modaltitle">
    <div style="display:flex;align-items:center;gap:8px">
      <h3 id="modaltitle">Detalhes da OS</h3>
      <button class="btn btn-ghost close-x" id="closeModal">Fechar</button>
    </div>

    <div class="actions">
      <button class="btn btn-green" id="btnReprint">Reimprimir</button>
      <button class="btn btn-blue"  id="btnDuplicate">Duplicar p/ Vendas</button>
      <button class="btn btn-ghost" id="btnToggleEdit">Editar</button>
      <button class="btn btn-danger" id="btnDelete">Excluir</button>
    </div>

    <div id="viewBox">
      <div class="hr"></div>
      <div style="color:#9ca3af;font-size:12px">Pré-visualização (texto 80mm / 42 colunas)</div>
      <pre id="viewPreview" class="preview"></pre>
    </div>

    <div id="editBox" style="display:none">
      <div class="hr"></div>
      <div class="grid2">
        <div>
          <label>Cliente</label>
          <input type="text" id="e_cliente">
        </div>
        <div>
          <label>Placa</label>
          <input type="text" id="e_placa">
        </div>
        <div>
          <label>Pedra</label>
          <input type="number" id="e_pedra" inputmode="numeric">
        </div>
        <div>
          <label>Observações</label>
          <input type="text" id="e_obs">
        </div>
      </div>
      <div class="hr"></div>
      <div style="color:#9ca3af;font-size:12px;margin-bottom:6px">Itens</div>
      <div id="e_itens"></div>
      <div class="hr"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" id="btnCancelEdit">Cancelar</button>
        <button class="btn btn-green" id="btnSaveEdit">Salvar alterações</button>
      </div>
    </div>
  </div>
</div>

<script>
/* Utils */
const $ = s => document.querySelector(s);
const money = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const pad2 = n => String(n).padStart(2,'0');
const W = 42;

function padRight(s,len){ s=String(s||''); return s.length>len? s.slice(0,len): s + ' '.repeat(len-s.length); }
function center(s,len){ s=String(s||''); const L=Math.floor((len-s.length)/2); return ' '.repeat(L)+s+' '.repeat(len-s.length-L); }
function wrapLines(text, width){
  if (!text) return [];
  const words = String(text).split(/\s+/);
  const lines = []; let line='';
  words.forEach(w=>{
    if ((line + (line?' ':'') + w).length <= width) line += (line?' ':'') + w;
    else { if (line) lines.push(line); while(w.length>width){ lines.push(w.slice(0,width)); w=w.slice(width);} line=w; }
  });
  if (line) lines.push(line);
  return lines;
}

function buildOSfrom(p){
  const d = new Date(p.createdAt || Date.now());
  const data = `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  const out = [];
  out.push(center('IRMÃOS HARTMANN', W));
  out.push(center('ORDEM DE SERVIÇO', W));
  out.push('='.repeat(W));
  out.push(padRight(`DATA: ${data}`, W));
  out.push(padRight(`CLIENTE: ${String(p.cliente||'').toUpperCase()}`, W));
  out.push(padRight(`PLACA: ${String(p.placa||'').toUpperCase()}`, W));
  out.push(padRight(`PEDRA: ${String(p.pedra||'').toUpperCase()}`, W));
  out.push('-'.repeat(W));
  out.push(padRight('PRODUTO:', W));
  out.push('');

  const obs = String(p.obs||'').trim().toUpperCase();
  if (obs){
    wrapLines('OBS: ' + obs, W).forEach(l => out.push(padRight(l, W)));
    out.push('');
  }

  let soma = 0;
  (p.itens||[]).forEach((it, idx)=>{
    const subtotal = (Number(it.qtd)||0) * (Number(it.unit)||0);
    soma += subtotal;
    wrapLines((it.produto||'').toUpperCase(), W).forEach(l => out.push(padRight(l, W)));
    const esquerda = `QTD: ${String(it.qtd).replace('.',',')} ${it.tipo} R$ ${money(it.unit)}`;
    const direita  = `TOTAL: R$ ${money(subtotal)}`;
    const espacos  = W - esquerda.length - direita.length;
    out.push(esquerda + ' '.repeat(espacos > 0 ? espacos : 1) + direita);
    if (idx < (p.itens.length-1)) out.push('');
  });

  out.push('-'.repeat(W));
  const totalNota = `TOTAL DA NOTA: R$ ${money(soma)}`;
  out.push(' '.repeat(Math.max(0, W - totalNota.length)) + totalNota);
  out.push('');
  out.push('Assinatura: __________________________');
  return out.join('\\n');
}

function totalFrom(p){
  return (p.itens||[]).reduce((acc,it)=> acc + (Number(it.qtd)||0)*(Number(it.unit)||0), 0);
}

/* Storage */
function loadAll(){
  try{ return JSON.parse(localStorage.getItem('os_arquivadas')||'[]'); }
  catch(e){ return []; }
}
function saveAll(arr){
  localStorage.setItem('os_arquivadas', JSON.stringify(arr));
}

/* Render lista */
let data = loadAll().sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
const list = $('#list');
function renderList(){
  list.innerHTML = '';
  if (!data.length){
    list.innerHTML = `<div class="row" style="cursor:default"><div class="meta"><b>Nenhuma OS arquivada</b><span class="muted">As OS que você arquivar aparecerão aqui.</span></div></div>`;
    return;
  }
  data.forEach((p,idx)=>{
    const d = new Date(p.createdAt||Date.now());
    const row = document.createElement('div');
    row.className = 'row';
    row.onclick = ()=> openModal(idx);
    row.innerHTML = `
      <div class="meta">
        <b>${(p.cliente||'').toUpperCase()}</b>
        <span class="muted">${d.toLocaleDateString('pt-BR')} ${d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span>
      </div>
      <div class="sum">TOTAL: R$ ${money(totalFrom(p))}</div>
    `;
    list.appendChild(row);
  });
}

/* Modal */
let currentIndex = null;
function openModal(i){
  currentIndex = i;
  $('#modal').style.display = 'flex';
  $('#editBox').style.display = 'none';
  $('#viewBox').style.display = '';
  $('#btnToggleEdit').textContent = 'Editar';
  renderModal();
}
function closeModal(){ $('#modal').style.display = 'none'; currentIndex = null; }
$('#closeModal').onclick = closeModal;

function renderModal(){
  if (currentIndex == null) return;
  const p = data[currentIndex];
  $('#viewPreview').textContent = buildOSfrom(p);

  // preencher editor (sem mostrar ainda)
  $('#e_cliente').value = p.cliente || '';
  $('#e_placa').value   = p.placa   || '';
  $('#e_pedra').value   = p.pedra   || '';
  $('#e_obs').value     = p.obs     || '';
  const box = $('#e_itens'); box.innerHTML='';

  (p.itens||[]).forEach((it,idx)=>{
    const row = document.createElement('div');
    row.className = 'itemRow';
    row.innerHTML = `
      <div class="itemInfo">
        <b>${(it.produto||'').toUpperCase()}</b><br>
        QTD: ${String(it.qtd).replace('.',',')} ${it.tipo} • V.UNIT: R$ ${money(it.unit)} • TOTAL: R$ ${money((Number(it.qtd)||0)*(Number(it.unit)||0))}
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-green" style="height:32px" title="Editar">Editar</button>
        <button class="btn btn-ghost" style="height:32px" title="Remover">Remover</button>
      </div>
    `;
    const [bEdit,bDel] = row.querySelectorAll('button');
    bEdit.onclick = ()=>{
      // editor inline simples com prompts (rápido) — se quiser faço inputs sofisticados
      const novoProd  = prompt('Produto:', it.produto||'');
      if (novoProd===null) return;
      const novoTipo  = prompt('Tipo (CX/KG):', it.tipo||'CX') || 'CX';
      const novaQtd   = prompt('Quantidade:', String(it.qtd||0)) || '0';
      const novoUnit  = prompt('V. Unitário (use ponto ou vírgula):', String(it.unit||0)) || '0';
      it.produto = (novoProd||'').toUpperCase();
      it.tipo    = (novoTipo||'CX').toUpperCase();
      it.qtd     = parseFloat(String(novaQtd).replace(',','.'))||0;
      it.unit    = parseFloat(String(novoUnit).replace('.','').replace(',','.'))||0;
      renderModal();
    };
    bDel.onclick = ()=>{
      p.itens.splice(idx,1);
      renderModal();
    };
    box.appendChild(row);
  });
}

/* Ações do modal */
$('#btnToggleEdit').onclick = ()=>{
  const edit = $('#editBox').style.display === 'none';
  $('#editBox').style.display = edit ? '' : 'none';
  $('#viewBox').style.display = edit ? 'none' : '';
  $('#btnToggleEdit').textContent = edit ? 'Voltar' : 'Editar';
};
$('#btnSaveEdit').onclick = ()=>{
  if (currentIndex==null) return;
  const p = data[currentIndex];
  p.cliente = $('#e_cliente').value.toUpperCase();
  p.placa   = $('#e_placa').value.toUpperCase();
  p.pedra   = $('#e_pedra').value.toUpperCase();
  p.obs     = $('#e_obs').value.toUpperCase();
  saveAll(data);
  // atualiza preview e lista
  renderModal();
  renderList();
  // volta para visualização
  $('#btnToggleEdit').click();
  alert('Alterações salvas!');
};
$('#btnDelete').onclick = ()=>{
  if (currentIndex==null) return;
  if (!confirm('Excluir esta OS arquivada?')) return;
  data.splice(currentIndex,1);
  saveAll(data);
  renderList();
  closeModal();
};
$('#btnReprint').onclick = async ()=>{
  if (currentIndex==null) return;
  const texto = buildOSfrom(data[currentIndex]);
  if (navigator.share){
    try { await navigator.share({ text: texto, title:'OS Hartmann' }); } catch(e){}
  }else{
    try{ await navigator.clipboard.writeText(texto); alert('OS copiada! Abra o app da impressora e cole.'); }
    catch(e){ alert('Selecione e copie manualmente do preview.'); }
  }
};
$('#btnDuplicate').onclick = ()=>{
  if (currentIndex==null) return;
  // envia a OS para vendas.html (sessionStorage)
  sessionStorage.setItem('restore_os', JSON.stringify(data[currentIndex]));
  window.location.href = 'vendas.html';
};
$('#btnCancelEdit').onclick = ()=>{ $('#btnToggleEdit').click(); };

window.addEventListener('load', renderList);
</script>

<script src="install.js"></script>
</body>
</html>
