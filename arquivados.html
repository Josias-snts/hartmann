<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>OS Arquivadas — Irmãos Hartmann</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --border:#2c3448;
    --green:#10f7a0; --blue:#0ea5e9; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif}
  .wrap{max-width:760px;margin:0 auto;padding:20px}
  h1{font-size:38px;line-height:1.1;margin:6px 0 12px}
  .top{display:flex;justify-content:space-between;align-items:center}
  .back{background:transparent;border:1px solid var(--border);color:var(--text);
        padding:10px 14px;border-radius:12px;text-decoration:none}
  .list{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
  .os-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;cursor:pointer}
  .os-card:hover{outline:2px solid #23314d}
  .os-top{display:flex;justify-content:space-between;gap:10px}
  .cliente{font-weight:800;font-size:22px}
  .total{background:#0b1220;border:1px solid var(--border);padding:6px 10px;border-radius:10px}
  .muted{color:var(--muted);font-size:14px;margin-top:6px}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;
                  align-items:center;justify-content:center;padding:20px;z-index:20}
  .modal{background:var(--card);border-radius:16px;max-width:760px;width:100%;max-height:92vh;
         overflow:auto;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.65)}
  .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .modal-title{font-weight:800;font-size:18px}
  .x{background:transparent;border:1px solid var(--border);color:var(--text);border-radius:10px;
     height:36px;padding:0 10px;cursor:pointer}

  .row{display:flex;gap:8px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
  .btn{height:44px;border:0;border-radius:12px;padding:0 14px;font-weight:800;cursor:pointer}
  .btn-blue{background:var(--blue);color:#001018}
  .btn-green{background:var(--green);color:#001c14}
  .btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn-danger{background:var(--danger);color:#220000}

  .preview-title{color:var(--muted);font-size:12px;margin:8px 0 4px}
  .preview{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space: pre-wrap; word-break: break-word; line-height: 1.2;
    margin: 6px 0 0; color: var(--text); width: 100%; background: transparent; padding: 0; border: 0;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>OS Arquivadas</h1>
    <a class="back" href="menu.html">Voltar ao menu</a>
  </div>

  <div id="list" class="list"></div>
  <div id="vazio" class="muted" style="display:none">Nenhuma OS arquivada ainda.</div>
</div>

<!-- Modal -->
<div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Detalhes da OS</div>
      <button class="x" id="btnClose">Fechar</button>
    </div>

    <div class="row">
      <button class="btn btn-blue"  id="btnReprint">Reimprimir</button>
      <button class="btn btn-green" id="btnDuplicate">Duplicar p/ Vendas</button>
      <button class="btn btn-outline" id="btnEdit">Editar</button>
      <button class="btn btn-danger" id="btnDelete">Excluir</button>
    </div>

    <div class="preview-title">Pré-visualização (texto 80mm / 42 colunas)</div>
    <pre id="preview" class="preview"></pre>
  </div>
</div>

<script>
/* ------------ utilidades de formatação iguais ao vendas.html ----------- */
const money = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const pad2 = n => String(n).padStart(2,'0');
const W = 42;
const padRight = (s,len)=>{ s=String(s||''); return s.length>len? s.slice(0,len): s + ' '.repeat(len-s.length); };
const center = (s,len)=>{ s=String(s||''); const L=Math.floor((len-s.length)/2); return ' '.repeat(L)+s+' '.repeat(len-s.length-L); };
function wrapLines(text, width){
  if (!text) return [];
  const words = String(text).split(/\s+/);
  const lines = []; let line='';
  words.forEach(w=>{
    if ((line + (line?' ':'') + w).length <= width) line += (line?' ':'') + w;
    else { if (line) lines.push(line); while(w.length>width){ lines.push(w.slice(0,width)); w=w.slice(width);} line=w; }
  });
  if (line) lines.push(line);
  return lines;
}
/* ---------------------------------------------------------------------- */

function totalFrom(rec){
  if (Array.isArray(rec.itens)) {
    return rec.itens.reduce((s,it)=>{
      const unit = (it.unit ?? it.valorUnitario ?? 0)*1;
      const qtd  = (it.qtd ?? 0)*1;
      return s + qtd*unit;
    },0);
  }
  if (typeof rec.total === 'number') return rec.total;
  // tenta ler do texto (opcional)
  return 0;
}

function buildOSFromRecord(rec){
  const d = rec.createdAt ? new Date(rec.createdAt) : new Date();
  const dataFmt = rec.data || `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

  const cliente = (rec.cliente||'').toUpperCase();
  const placa   = (rec.placa||'').toUpperCase();
  const pedra   = (rec.pedra||'').toUpperCase();
  const obs     = (rec.obs||'').trim().toUpperCase();

  const out = [];
  out.push(center('IRMÃOS HARTMANN', W));
  out.push(center('ORDEM DE SERVIÇO', W));
  out.push('='.repeat(W));
  out.push(padRight(`DATA: ${dataFmt}`, W));
  out.push(padRight(`CLIENTE: ${cliente}`, W));
  out.push(padRight(`PLACA: ${placa}`, W));
  out.push(padRight(`PEDRA: ${pedra}`, W));
  out.push('-'.repeat(W));
  out.push(padRight('PRODUTO:', W));
  out.push('');

  if (obs){
    wrapLines('OBS: ' + obs, W).forEach(l => out.push(padRight(l, W)));
    out.push('');
  }

  let soma = 0;
  (rec.itens||[]).forEach((it, idx)=>{
    const nome = (it.produto||'').toUpperCase();
    const unit = (it.unit ?? it.valorUnitario ?? 0)*1;
    const qtd  = (it.qtd ?? 0)*1;
    const tipo = (it.tipo || '').toUpperCase();
    const subtotal = qtd * unit;
    soma += subtotal;

    wrapLines(nome, W).forEach(l => out.push(padRight(l, W)));

    const esquerda = `QTD: ${String(qtd).replace('.',',')} ${tipo} R$ ${money(unit)}`;
    const direita  = `TOTAL: R$ ${money(subtotal)}`;
    const espacos  = W - esquerda.length - direita.length;
    out.push(esquerda + ' '.repeat(espacos > 0 ? espacos : 1) + direita);

    if (idx < rec.itens.length - 1) out.push('');
  });

  out.push('-'.repeat(W));
  const totalNota = `TOTAL DA NOTA: R$ ${money(soma)}`;
  out.push(' '.repeat(Math.max(0, W - totalNota.length)) + totalNota);
  out.push('');
  out.push('Assinatura: __________________________');

  return out.join('\n');
}

// Usa itens se houver; senão, usa texto salvo, normalizando "\n" -> quebra real
function recordToPrintable(rec){
  if (Array.isArray(rec.itens) && rec.itens.length) return buildOSFromRecord(rec);
  const t = String(rec.texto || '');
  return t.replace(/\\n/g, '\n');
}

/* ------------------------ dados / renderização ------------------------ */
let data = [];
let currentIndex = -1;

function loadData(){
  try { data = JSON.parse(localStorage.getItem('os_arquivadas')||'[]'); }
  catch(e){ data = []; }

  // Migração simples: se texto vier com "\n", normaliza na visualização (não regrava).
  // Se no futuro quiser regravar normalizado, habilite a linha comentada:
  // localStorage.setItem('os_arquivadas', JSON.stringify(data));
}

function renderList(){
  const list = document.getElementById('list');
  const vazio = document.getElementById('vazio');
  list.innerHTML = '';

  if (!data.length){
    vazio.style.display = 'block';
    return;
  }
  vazio.style.display = 'none';

  data.forEach((rec, i)=>{
    const div = document.createElement('div');
    div.className = 'os-card';
    const total = totalFrom(rec);
    const nome = (rec.cliente||'').toUpperCase() || '—';
    const quando = rec.createdAt ? new Date(rec.createdAt) : null;
    const dt = quando
      ? `${pad2(quando.getDate())}/${pad2(quando.getMonth()+1)}/${quando.getFullYear()} ${pad2(quando.getHours())}:${pad2(quando.getMinutes())}`
      : (rec.data || '');

    div.innerHTML = `
      <div class="os-top">
        <div class="cliente">${nome}</div>
        <div class="total">TOTAL: R$ ${money(total)}</div>
      </div>
      <div class="muted">${dt}</div>
    `;
    div.onclick = ()=> openModal(i);
    list.appendChild(div);
  });
}

/* ----------------------------- modal --------------------------------- */
function openModal(i){
  currentIndex = i;
  const rec = data[i];
  document.getElementById('preview').textContent = recordToPrintable(rec);
  document.getElementById('backdrop').style.display = 'flex';
}
function closeModal(){
  document.getElementById('backdrop').style.display = 'none';
}
document.getElementById('btnClose').onclick = closeModal;

/* --------------------------- ações modal ------------------------------ */
async function shareText(text){
  if (navigator.share){
    try { await navigator.share({ text, title:'OS Hartmann' }); }
    catch(e){} // cancelado
  } else {
    try {
      await navigator.clipboard.writeText(text);
      alert('OS copiada! Abra o app da impressora e cole.');
    } catch(e){
      alert('Selecione e copie manualmente da prévia.');
    }
  }
}

document.getElementById('btnReprint').onclick = async ()=>{
  if (currentIndex<0) return;
  const txt = recordToPrintable(data[currentIndex]);
  await shareText(txt);
};

document.getElementById('btnDelete').onclick = ()=>{
  if (currentIndex<0) return;
  if (!confirm('Excluir esta OS?')) return;
  data.splice(currentIndex,1);
  localStorage.setItem('os_arquivadas', JSON.stringify(data));
  renderList();
  closeModal();
};

document.getElementById('btnDuplicate').onclick = ()=>{
  if (currentIndex<0) return;
  localStorage.setItem('duplicar_para_vendas', JSON.stringify(data[currentIndex]));
  location.href = 'vendas.html';
};

document.getElementById('btnEdit').onclick = ()=>{
  if (currentIndex<0) return;
  localStorage.setItem('editar_os', JSON.stringify(data[currentIndex]));
  location.href = 'vendas.html';
};

/* ----------------------------- start ---------------------------------- */
loadData();
renderList();

/* Opcional: registra o SW se você usa PWA */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>  .preview{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space: pre-wrap; word-break: break-word; line-height:1.2;
    margin:0; color: var(--text); background:transparent; border:0; padding:0;
  }
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="toprow">
    <h1>OS Arquivadas</h1>
    <a class="back" href="menu.html">Voltar ao menu</a>
  </div>
  <div id="lista"></div>
  <div id="vazio" class="subtitle">Nenhuma OS arquivada ainda.</div>
</div>

<!-- Modal -->
<div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Detalhes da OS</div>
      <button class="x" id="btnClose">Fechar</button>
    </div>

    <div class="grid3">
      <button id="btnReprint" class="btn btn-green">Reimprimir</button>
      <button id="btnDuplicate" class="btn btn-blue">Duplicar p/ Vendas</button>
      <button id="btnEdit" class="btn btn-orange">Editar</button>
    </div>
    <div class="grid2">
      <button id="btnDelete" class="btn btn-red">Excluir</button>
    </div>

    <div class="preview-title">Pré-visualização (texto 80mm / 42 colunas)</div>
    <pre id="preview" class="preview"></pre>
  </div>
</div>

<script>
/* ===== Helpers (iguais ao vendas.html) ===== */
const W = 42;
const money = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const padRight = (s,len)=>{ s=String(s||''); return s.length>len? s.slice(0,len): s + ' '.repeat(len-s.length); };
const center = (s,len)=>{ s=String(s||''); const L=Math.floor((len-s.length)/2); return ' '.repeat(L)+s+' '.repeat(len-s.length-L); };
function wrapLines(text, width){
  if (!text) return [];
  const words = String(text).split(/\s+/);
  const lines = []; let line='';
  words.forEach(w=>{
    if ((line + (line?' ':'') + w).length <= width) line += (line?' ':'') + w;
    else { if (line) lines.push(line); while(w.length>width){ lines.push(w.slice(0,width)); w=w.slice(width);} line=w; }
  });
  if (line) lines.push(line);
  return lines;
}

function buildOSFromRecord(rec){
  const out = [];
  out.push(center('IRMÃOS HARTMANN', W));
  out.push(center('ORDEM DE SERVIÇO', W));
  out.push('='.repeat(W));
  const dataStr = rec.data || new Date(rec.createdAt||Date.now()).toLocaleString('pt-BR');
  out.push(padRight(`DATA: ${dataStr}`, W));
  out.push(padRight(`CLIENTE: ${String(rec.cliente||'').toUpperCase()}`, W));
  out.push(padRight(`PLACA: ${String(rec.placa||'').toUpperCase()}`, W));
  out.push(padRight(`PEDRA: ${String(rec.pedra||'').toUpperCase()}`, W));
  out.push('-'.repeat(W));
  out.push(padRight('PRODUTO:', W));
  out.push('');

  let soma = 0;
  (rec.itens||[]).forEach((it, idx)=>{
    const nome = String(it.produto||'').toUpperCase();
    const qtd  = String(it.qtd).replace('.',',');
    const tipo = String(it.tipo||'').toUpperCase();   // CX / KG / UN
    const unit = Number(it.unit ?? it.valorUnitario ?? 0);
    const subtotal = (Number(it.qtd||0) * unit);
    soma += subtotal;

    wrapLines(nome, W).forEach(l => out.push(padRight(l, W)));

    const esquerda = `QTD: ${qtd} ${tipo} R$ ${money(unit)}`;
    const direita  = `TOTAL: R$ ${money(subtotal)}`;
    const espacos  = W - esquerda.length - direita.length;
    out.push(esquerda + ' '.repeat(espacos > 0 ? espacos : 1) + direita);

    if (idx < rec.itens.length - 1) out.push('');
  });

  out.push('-'.repeat(W));
  const totalNota = `TOTAL DA NOTA: R$ ${money(Number(rec.total || 0) || soma)}`;
  out.push(' '.repeat(Math.max(0, W - totalNota.length)) + totalNota);
  out.push('');
  out.push('Assinatura: __________________________');
  return out.join('\n');
}

function recordToPrintable(rec){
  if (Array.isArray(rec.itens) && rec.itens.length) return buildOSFromRecord(rec);
  const t = String(rec.texto || '');
  return t.replace(/\\n/g, '\n'); // normaliza legado
}

/* ===== Estado/Render ===== */
const $ = s => document.querySelector(s);
let data = [];

function loadData(){
  try{ data = JSON.parse(localStorage.getItem('os_arquivadas')||'[]') || []; }
  catch{ data = []; }

  // normaliza registros antigos com "\n"
  let alterou = false;
  data = data.map(rec=>{
    if ((!rec.itens || !rec.itens.length) && typeof rec.texto === 'string' && rec.texto.includes('\\n')){
      alterou = true;
      return { ...rec, texto: rec.texto.replace(/\\n/g, '\n') };
    }
    return rec;
  });
  if (alterou) localStorage.setItem('os_arquivadas', JSON.stringify(data));
}

function renderList(){
  const lista = $('#lista');
  const vazio = $('#vazio');
  lista.innerHTML = '';
  if (!data.length){ vazio.style.display='block'; return; }
  vazio.style.display='none';

  data.forEach((rec,i)=>{
    const total = rec.total ?? (Array.isArray(rec.itens)? rec.itens.reduce((s,it)=>s+(Number(it.qtd||0)*Number(it.unit||0)),0):0);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="title">${(rec.cliente||'').toUpperCase()}</div>
      <div class="row">
        <div class="subtitle">${new Date(rec.createdAt||Date.now()).toLocaleString('pt-BR')}</div>
        <div class="pill">TOTAL: R$ ${money(total)}</div>
      </div>
    `;
    card.style.cursor='pointer';
    card.onclick = ()=>openModal(i);
    lista.appendChild(card);
  });
}

/* ===== Modal ações ===== */
let currentIndex = -1;
function openModal(i){
  currentIndex = i;
  $('#preview').textContent = recordToPrintable(data[i]);
  $('#backdrop').style.display='flex';
}
function closeModal(){
  $('#backdrop').style.display='none';
  currentIndex = -1;
}
$('#btnClose').onclick = closeModal;

async function shareText(text){
  if (navigator.share){
    try{ await navigator.share({ text, title:'OS Hartmann' }); }catch(e){}
  }else{
    try{ await navigator.clipboard.writeText(text); alert('OS copiada! Abra o app da impressora e cole.'); }
    catch{ alert('Selecione e copie manualmente da prévia.'); }
  }
}
$('#btnReprint').onclick = async ()=>{
  if (currentIndex<0) return;
  await shareText(recordToPrintable(data[currentIndex]));
};
$('#btnDuplicate').onclick = ()=>{
  if (currentIndex<0) return;
  localStorage.setItem('os_draft_from_archive', JSON.stringify(data[currentIndex]));
  location.href='vendas.html';
};
$('#btnEdit').onclick = ()=>{
  if (currentIndex<0) return;
  localStorage.setItem('os_editar_from_archive', JSON.stringify({ index: currentIndex, rec: data[currentIndex] }));
  location.href='vendas.html';
};
$('#btnDelete').onclick = ()=>{
  if (currentIndex<0) return;
  if (!confirm('Excluir esta OS arquivada?')) return;
  data.splice(currentIndex,1);
  localStorage.setItem('os_arquivadas', JSON.stringify(data));
  closeModal();
  renderList();
};

/* init */
loadData();
renderList();
</script>
</body>
</html>    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space: pre-wrap; word-break: break-word; line-height:1.2;
    margin:0; color: var(--text); background:transparent; border:0; padding:0;
  }
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="toprow">
    <h1>OS Arquivadas</h1>
    <a class="back" href="menu.html">Voltar ao menu</a>
  </div>

  <div id="lista"></div>
  <div id="vazio" class="subtitle">Nenhuma OS arquivada ainda.</div>
</div>

<!-- Modal -->
<div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Detalhes da OS</div>
      <button class="x" id="btnClose">Fechar</button>
    </div>

    <div class="grid3">
      <button id="btnReprint" class="btn btn-green">Reimprimir</button>
      <button id="btnDuplicate" class="btn btn-blue">Duplicar p/ Vendas</button>
      <button id="btnEdit" class="btn btn-orange">Editar</button>
    </div>
    <div class="grid2">
      <button id="btnDelete" class="btn btn-red">Excluir</button>
    </div>

    <div class="preview-title">Pré-visualização (texto 80mm / 42 colunas)</div>
    <pre id="preview" class="preview"></pre>
  </div>
</div>

<script>
/* ===== Utils (mesmo layout do vendas.html) ===== */
const W = 42;
const money = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const padRight = (s,len)=>{ s=String(s||''); return s.length>len? s.slice(0,len): s + ' '.repeat(len-s.length); };
const center = (s,len)=>{ s=String(s||''); const L=Math.floor((len-s.length)/2); return ' '.repeat(L)+s+' '.repeat(len-s.length-L); };
function wrapLines(text, width){
  if (!text) return [];
  const words = String(text).split(/\s+/);
  const lines = []; let line='';
  words.forEach(w=>{
    if ((line + (line?' ':'') + w).length <= width) line += (line?' ':'') + w;
    else { if (line) lines.push(line); while(w.length>width){ lines.push(w.slice(0,width)); w=w.slice(width);} line=w; }
  });
  if (line) lines.push(line);
  return lines;
}

function buildOSFromRecord(rec){
  const out = [];
  out.push(center('IRMÃOS HARTMANN', W));
  out.push(center('ORDEM DE SERVIÇO', W));
  out.push('='.repeat(W));
  const dataStr = rec.data || new Date(rec.createdAt||Date.now()).toLocaleString('pt-BR');
  out.push(padRight(`DATA: ${dataStr}`, W));
  out.push(padRight(`CLIENTE: ${String(rec.cliente||'').toUpperCase()}`, W));
  out.push(padRight(`PLACA: ${String(rec.placa||'').toUpperCase()}`, W));
  out.push(padRight(`PEDRA: ${String(rec.pedra||'').toUpperCase()}`, W));
  out.push('-'.repeat(W));
  out.push(padRight('PRODUTO:', W));
  out.push('');

  let soma = 0;
  (rec.itens||[]).forEach((it, idx)=>{
    const nome = String(it.produto||'').toUpperCase();
    const qtd  = (String(it.qtd).replace('.',','));
    const tipo = String(it.tipo||'').toUpperCase();      // CX / KG / UN
    const unit = Number(it.unit ?? it.valorUnitario ?? 0);
    const subtotal = (Number(it.qtd||0) * unit);
    soma += subtotal;

    wrapLines(nome, W).forEach(l => out.push(padRight(l, W)));

    const esquerda = `QTD: ${qtd} ${tipo} R$ ${money(unit)}`;
    const direita  = `TOTAL: R$ ${money(subtotal)}`;
    const espacos  = W - esquerda.length - direita.length;
    out.push(esquerda + ' '.repeat(espacos > 0 ? espacos : 1) + direita);

    if (idx < rec.itens.length - 1) out.push('');
  });

  out.push('-'.repeat(W));
  const totalNota = `TOTAL DA NOTA: R$ ${money(Number(rec.total || 0) || soma)}`;
  out.push(' '.repeat(Math.max(0, W - totalNota.length)) + totalNota);
  out.push('');
  out.push('Assinatura: __________________________');

  return out.join('\n');
}

function recordToPrintable(rec){
  if (Array.isArray(rec.itens) && rec.itens.length) return buildOSFromRecord(rec);
  const t = String(rec.texto || '');
  return t.replace(/\\n/g, '\n'); // normaliza legado
}

/* ===== Estado / Lista ===== */
const $ = s => document.querySelector(s);
let data = [];

function loadData(){
  try{ data = JSON.parse(localStorage.getItem('os_arquivadas')||'[]') || []; }
  catch{ data = []; }

  // normaliza legado
  let alterou = false;
  data = data.map(rec=>{
    if ((!rec.itens || !rec.itens.length) && typeof rec.texto === 'string' && rec.texto.includes('\\n')){
      alterou = true;
      return { ...rec, texto: rec.texto.replace(/\\n/g, '\n') };
    }
    return rec;
  });
  if (alterou) localStorage.setItem('os_arquivadas', JSON.stringify(data));
}

function renderList(){
  const lista = $('#lista');
  const vazio = $('#vazio');
  lista.innerHTML = '';
  if (!data.length){ vazio.style.display='block'; return; }
  vazio.style.display='none';

  data.forEach((rec,i)=>{
    const total = rec.total ?? (Array.isArray(rec.itens)? rec.itens.reduce((s,it)=>s+(Number(it.qtd||0)*Number(it.unit||0)),0):0);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="title">${(rec.cliente||'').toUpperCase()}</div>
      <div class="row">
        <div class="subtitle">${new Date(rec.createdAt||Date.now()).toLocaleString('pt-BR')}</div>
        <div class="pill">TOTAL: R$ ${money(total)}</div>
      </div>
    `;
    card.style.cursor='pointer';
    card.onclick = ()=>openModal(i);
    lista.appendChild(card);
  });
}

/* ===== Modal ===== */
let currentIndex = -1;
function openModal(i){
  currentIndex = i;
  $('#preview').textContent = recordToPrintable(data[i]);
  $('#backdrop').style.display='flex';
}
function closeModal(){
  $('#backdrop').style.display='none';
  currentIndex = -1;
}
$('#btnClose').onclick = closeModal;

async function shareText(text){
  if (navigator.share){
    try{ await navigator.share({ text, title:'OS Hartmann' }); }catch(e){}
  }else{
    try{ await navigator.clipboard.writeText(text); alert('OS copiada! Abra o app da impressora e cole.'); }
    catch{ alert('Selecione e copie manualmente da prévia.'); }
  }
}
$('#btnReprint').onclick = async ()=>{
  if (currentIndex<0) return;
  await shareText(recordToPrintable(data[currentIndex]));
};
$('#btnDuplicate').onclick = ()=>{
  if (currentIndex<0) return;
  localStorage.setItem('os_draft_from_archive', JSON.stringify(data[currentIndex]));
  location.href='vendas.html';
};
$('#btnEdit').onclick = ()=>{
  if (currentIndex<0) return;
  localStorage.setItem('os_editar_from_archive', JSON.stringify({ index: currentIndex, rec: data[currentIndex] }));
  location.href='vendas.html';
};
$('#btnDelete').onclick = ()=>{
  if (currentIndex<0) return;
  if (!confirm('Excluir esta OS arquivada?')) return;
  data.splice(currentIndex,1);
  localStorage.setItem('os_arquivadas', JSON.stringify(data));
  closeModal();
  renderList();
};

/* init */
loadData();
renderList();
</script>
</body>
</html>  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    display:none; align-items:center; justify-content:center; padding:20px; z-index:20;
  }
  .modal{background:var(--card); border-radius:16px; max-width:760px; width:100%; max-height:92vh; overflow:auto; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.65);}
  .modal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
  .modal-title{font-weight:800; font-size:18px}
  .x{background:transparent; border:1px solid var(--border); color:var(--text); border-radius:10px; height:36px; padding:0 10px; cursor:pointer}
  label{font-size:14px;color:var(--muted);margin-top:8px;display:block}
  input,select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
    background:#0b1220;color:var(--text);margin-top:4px;margin-bottom:8px;text-transform:uppercase;
  }
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .grid4{display:grid; grid-template-columns:2fr .8fr .8fr .9fr; gap:8px}
  .item-row{display:flex; gap:8px; align-items:flex-end; margin-bottom:6px}
  .small{font-size:12px; color:var(--muted)}
  .sep{border-top:1px solid var(--border); margin:10px 0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="link-top" href="menu.html">Voltar ao menu</a>
    </div>

    <div class="title">OS Arquivadas</div>
    <div id="lista"></div>
  </div>

  <!-- Modal de Edição -->
  <div id="backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Editar OS arquivada</div>
        <button class="x" id="fecharModal">Fechar</button>
      </div>

      <div id="editForm">
        <div class="grid2">
          <div>
            <label>Cliente</label>
            <input id="e_cliente" type="text" placeholder="NOME DO CLIENTE">
          </div>
          <div>
            <label>Placa</label>
            <input id="e_placa" type="text" placeholder="ABC1D23">
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Pedra</label>
            <input id="e_pedra" type="number" inputmode="numeric" placeholder="07">
          </div>
          <div>
            <label>Observações</label>
            <input id="e_obs" type="text" placeholder="">
          </div>
        </div>

        <div class="sep"></div>
        <div class="small">Itens (produto, tipo, qtd, v.unit). Você pode adicionar/remover itens.</div>
        <div id="itensBox"></div>
        <button class="btn btn-outline" id="btnAddItem" type="button">+ Adicionar item</button>

        <div class="sep"></div>
        <div class="small">Pré-visualização (80mm / 42 colunas)</div>
        <pre id="e_preview" class="preview"></pre>

        <div class="rowBtns" style="margin-top:10px">
          <button class="btn btn-blue"  id="btnSalvar">Salvar alterações</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Utilidades compartilhadas ----------
  const $ = s => document.querySelector(s);
  const money = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const pad2 = n => String(n).padStart(2,'0');

  const W = 42;
  const padRight = (s,len)=>{ s=String(s||''); return s.length>len? s.slice(0,len): s + ' '.repeat(len-s.length); };
  const center = (s,len)=>{ s=String(s||''); const L=Math.floor((len-s.length)/2); return ' '.repeat(L)+s+' '.repeat(len-s.length-L); };

  function wrapLines(text, width){
    if (!text) return [];
    const words = String(text).split(/\s+/);
    const lines = []; let line='';
    words.forEach(w=>{
      if ((line + (line?' ':'') + w).length <= width) line += (line?' ':'') + w;
      else { if (line) lines.push(line); while(w.length>width){ lines.push(w.slice(0,width)); w=w.slice(width);} line=w; }
    });
    if (line) lines.push(line);
    return lines;
  }

  function normalizeText(t){
    return String(t || '')
      .replace(/\r\n/g, '\n')
      .replace(/\r/g, '\n')
      .replace(/\\n/g, '\n');
  }

  function parseNum(str){
    if (str === '' || str === null || str === undefined) return 0;
    return parseFloat(String(str).replace('.','').replace(',','.')) || 0;
  }

  // Monta OS no MESMO formato do vendas.html
  function buildOSFromData(data){
    const d = new Date(data.createdAt || Date.now());
    const dataStr = `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

    const cliente = (data.cliente||'').toUpperCase();
    const placa   = (data.placa||'').toUpperCase();
    const pedra   = (data.pedra||'').toUpperCase();
    const obs     = (data.obs||'').trim().toUpperCase();

    const out = [];
    out.push(center('IRMÃOS HARTMANN', W));
    out.push(center('ORDEM DE SERVIÇO', W));
    out.push('='.repeat(W));
    out.push(padRight(`DATA: ${dataStr}`, W));
    out.push(padRight(`CLIENTE: ${cliente}`, W));
    out.push(padRight(`PLACA: ${placa}`, W));
    out.push(padRight(`PEDRA: ${pedra}`, W));
    out.push('-'.repeat(W));
    out.push(padRight('PRODUTO:', W));
    out.push('');

    if (obs){
      wrapLines('OBS: ' + obs, W).forEach(l => out.push(padRight(l, W)));
      out.push('');
    }

    let soma = 0;
    (data.itens || []).forEach((it, idx)=>{
      const qtd  = parseNum(it.qtd);
      const unit = parseNum(it.unit);
      const subtotal = qtd * unit;
      soma += subtotal;

      wrapLines((it.produto||'').toUpperCase(), W).forEach(l => out.push(padRight(l, W)));

      const esquerda = `QTD: ${String(qtd).replace('.',',')} ${String(it.tipo||'').toUpperCase()} R$ ${money(unit)}`;
      const direita  = `TOTAL: R$ ${money(subtotal)}`;
      const espacos  = W - esquerda.length - direita.length;
      out.push(esquerda + ' '.repeat(espacos > 0 ? espacos : 1) + direita);

      if (idx < data.itens.length - 1) out.push('');
    });

    out.push('-'.repeat(W));
    const totalNota = `TOTAL DA NOTA: R$ ${money(soma)}`;
    out.push(' '.repeat(Math.max(0, W - totalNota.length)) + totalNota);
    out.push('');
    out.push('Assinatura: __________________________');

    return out.join('\n');
  }

  // ---------- Lista ----------
  function carregar(){
    let list = [];
    try { list = JSON.parse(localStorage.getItem('os_arquivadas') || '[]'); } catch(e){ list = []; }

    const cont = $('#lista');
    cont.innerHTML = '';

    if (!list.length){
      cont.innerHTML = '<div class="empty">Nenhuma OS arquivada ainda.</div>';
      return;
    }

    list
      .map((x,i)=>({idx:i, ...x}))
      .sort((a,b)=> b.createdAt - a.createdAt)
      .forEach(item=>{
        const card = document.createElement('div');
        card.className = 'card';

        const quando = item.createdAt ? new Date(item.createdAt) : null;
        const cab = document.createElement('div');
        cab.className = 'muted';
        cab.textContent =
          (quando ? `Salvo: ${quando.toLocaleDateString()} ${quando.toLocaleTimeString().slice(0,5)} • ` : '') +
          (item.cliente ? `Cliente: ${item.cliente.toUpperCase()}` : '');
        card.appendChild(cab);

        const pre = document.createElement('pre');
        pre.className = 'preview';
        pre.textContent = normalizeText(item.texto || buildOSFromData(item));
        card.appendChild(pre);

        const row = document.createElement('div');
        row.className = 'rowBtns';

        const btnPrint = document.createElement('button');
        btnPrint.className = 'btn btn-green';
        btnPrint.textContent = 'Imprimir';
        btnPrint.onclick = async ()=>{
          const texto = normalizeText(item.texto || buildOSFromData(item));
          if (navigator.share){
            try{ await navigator.share({ text: texto, title: 'OS Hartmann' }); }catch(e){}
          }else{
            try{ await navigator.clipboard.writeText(texto); alert('OS copiada! Abra o app da impressora e cole.'); }
            catch(e){ alert('Não foi possível copiar. Selecione o texto manualmente.'); }
          }
        };
        row.appendChild(btnPrint);

        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-blue';
        btnEdit.textContent = 'Editar';
        btnEdit.onclick = ()=> abrirEditor(item.idx);
        row.appendChild(btnEdit);

        const btnDel = document.createElement('button');
        btnDel.className = 'btn btn-orange';
        btnDel.textContent = 'Excluir';
        btnDel.onclick = ()=>{
          if (!confirm('Remover esta OS arquivada?')) return;
          let all = JSON.parse(localStorage.getItem('os_arquivadas') || '[]');
          all.splice(item.idx, 1);
          localStorage.setItem('os_arquivadas', JSON.stringify(all));
          carregar();
        };
        row.appendChild(btnDel);

        card.appendChild(row);

        cont.appendChild(card);
      });
  }

  // ---------- Editor (Modal) ----------
  let editIndex = null;
  function abrirEditor(idx){
    editIndex = idx;
    const all = JSON.parse(localStorage.getItem('os_arquivadas') || '[]');
    const it  = all[idx];

    $('#e_cliente').value = (it.cliente||'').toUpperCase();
    $('#e_placa').value   = (it.placa||'').toUpperCase();
    $('#e_pedra').value   = it.pedra || '';
    $('#e_obs').value     = (it.obs||'').toUpperCase();

    // monta itens
    const box = $('#itensBox');
    box.innerHTML = '';
    (it.itens||[]).forEach((obj,i)=> addItemRow(obj.produto||'', obj.tipo||'CX', obj.qtd||0, obj.unit||0));

    // prévia
    atualizarPreviewEditor();

    // abrir
    $('#backdrop').style.display = 'flex';
  }

  $('#fecharModal').onclick = ()=>{ $('#backdrop').style.display = 'none'; };

  function addItemRow(produto='', tipo='CX', qtd=0, unit=0){
    const row = document.createElement('div');
    row.className = 'item-row';

    const g = document.createElement('div');
    g.className = 'grid4';
    row.appendChild(g);

    const inpProd = document.createElement('input');
    inpProd.placeholder='PRODUTO';
    inpProd.value = String(produto).toUpperCase();
    g.appendChild(inpProd);

    const selTipo = document.createElement('select');
    selTipo.innerHTML = `<option value="CX">CX</option><option value="KG">KG</option>`;
    selTipo.value = String(tipo||'CX').toUpperCase();
    g.appendChild(selTipo);

    const inpQtd = document.createElement('input');
    inpQtd.type='number'; inpQtd.step='0.01'; inpQtd.inputMode='decimal';
    inpQtd.placeholder='QTD'; inpQtd.value= qtd;
    g.appendChild(inpQtd);

    const inpUnit = document.createElement('input');
    inpUnit.type='text'; inpUnit.inputMode='numeric'; inpUnit.placeholder='0,00';
    // máscara dinheiro
    inpUnit.value = (parseFloat(unit)||0).toFixed(2).replace('.',',');
    inpUnit.addEventListener('input', e=>{
      let val = e.target.value.replace(/\D/g, '');
      val = (parseInt(val || '0', 10) / 100).toFixed(2);
      e.target.value = val.replace('.', ',');
      atualizarPreviewEditor();
    });

    g.appendChild(inpUnit);

    const btnRem = document.createElement('button');
    btnRem.className='btn btn-outline';
    btnRem.textContent='Remover';
    btnRem.type='button';
    btnRem.onclick=()=>{ row.remove(); atualizarPreviewEditor(); };
    row.appendChild(btnRem);

    [inpProd, selTipo, inpQtd].forEach(el=>{
      el.addEventListener('input', ()=>{
        if (el === inpProd) el.value = el.value.toUpperCase();
        atualizarPreviewEditor();
      });
    });

    $('#itensBox').appendChild(row);
  }

  $('#btnAddItem').onclick = ()=> addItemRow('','CX',0,0);

  function coletarFormEditor(){
    const itens = [];
    document.querySelectorAll('#itensBox .item-row').forEach(r=>{
      const [prod, tipo, qtd, unit] = r.querySelectorAll('input,select');
      itens.push({
        produto: (prod.value||'').toUpperCase(),
        tipo: (tipo.value||'CX').toUpperCase(),
        qtd: parseNum(qtd.value),
        unit: parseNum(unit.value)
      });
    });

    return {
      cliente: ($('#e_cliente').value||'').toUpperCase(),
      placa: ($('#e_placa').value||'').toUpperCase(),
      pedra: ($('#e_pedra').value||''),
      obs: ($('#e_obs').value||'').toUpperCase(),
      itens
    };
  }

  function atualizarPreviewEditor(){
    const base = coletarFormEditor();
    base.createdAt = Date.now();
    $('#e_preview').textContent = buildOSFromData(base);
  }

  // Atualiza prévia quando campos do cabeçalho mudam
  ['e_cliente','e_placa','e_pedra','e_obs'].forEach(id=>{
    $('#'+id).addEventListener('input', e=>{
      if (id!=='e_pedra'){ // manter uppercase para textos
        const pos = e.target.selectionStart;
        e.target.value = e.target.value.toUpperCase();
        e.target.setSelectionRange(pos,pos);
      }
      atualizarPreviewEditor();
    });
  });

  $('#btnSalvar').onclick = ()=>{
    if (editIndex===null) return;
    const all = JSON.parse(localStorage.getItem('os_arquivadas') || '[]');
    const original = all[editIndex] || {};
    const novo = {...original, ...coletarFormEditor()};
    // Regenera o texto da OS
    novo.texto = buildOSFromData(novo);
    all[editIndex] = novo;
    localStorage.setItem('os_arquivadas', JSON.stringify(all));
    $('#backdrop').style.display = 'none';
    carregar();
  };

  carregar();
</script>
</body>
</html>et data = [];
let currentIndex = -1;

function buildOSFromRecord(rec){
  let header = "         IRMÃOS HARTMANN\n           ORDEM DE SERVIÇO\n";
  header += "==========================================\n";
  header += `DATA: ${rec.data}\nCLIENTE: ${rec.cliente}\nPLACA: ${rec.placa}\nPEDRA: ${rec.pedra}\n`;
  header += "------------------------------------------\nPRODUTO:\n";
  rec.itens.forEach(it=>{
    header += `${it.produto}\nQTD: ${it.qtd} ${it.tipo} R$ ${it.valorUnitario}   TOTAL: R$ ${it.total}\n`;
  });
  header += "------------------------------------------\n";
  header += `TOTAL DA NOTA: R$ ${rec.total}\n\nAssinatura:\n______________________________`;
  return header;
}

function recordToPrintable(rec){
  if (Array.isArray(rec.itens) && rec.itens.length) {
    return buildOSFromRecord(rec);
  }
  const t = String(rec.texto || '');
  return t.replace(/\\n/g, '\n');
}

function renderList(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  data.forEach((rec, i)=>{
    const div = document.createElement('div');
    div.className = 'os-card';
    div.innerHTML = `<strong>${rec.cliente}</strong> - TOTAL: R$ ${rec.total || ''}<br><small>${rec.data}</small>`;
    div.onclick = ()=>openModal(i);
    list.appendChild(div);
  });
}

function openModal(i){
  currentIndex = i;
  const rec = data[i];
  document.getElementById('preview').textContent = recordToPrintable(rec);
  document.getElementById('backdrop').style.display = 'flex';
}

document.getElementById('btnReprint').onclick = async ()=>{
  if (currentIndex<0) return;
  const txt = recordToPrintable(data[currentIndex]);
  if (navigator.share){
    try{ await navigator.share({ text: txt, title:'OS Hartmann' }); }catch{}
  }else{
    try{ await navigator.clipboard.writeText(txt); alert('OS copiada! Abra o app da impressora e cole.'); }
    catch{ alert('Selecione e copie manualmente da prévia.'); }
  }
};

document.getElementById('btnDelete').onclick = ()=>{
  if (currentIndex<0) return;
  if (confirm('Excluir esta OS?')){
    data.splice(currentIndex,1);
    localStorage.setItem('os_arquivadas', JSON.stringify(data));
    renderList();
    backdrop.style.display='none';
  }
};

document.getElementById('btnDuplicate').onclick = ()=>{
  if (currentIndex<0) return;
  localStorage.setItem('duplicar_para_vendas', JSON.stringify(data[currentIndex]));
  location.href = 'vendas.html';
};

document.getElementById('btnEdit').onclick = ()=>{
  if (currentIndex<0) return;
  localStorage.setItem('editar_os', JSON.stringify(data[currentIndex]));
  location.href = 'vendas.html';
};

function load(){
  try{ data = JSON.parse(localStorage.getItem('os_arquivadas')||'[]'); }
  catch{ data = []; }

  // MIGRAÇÃO: converte OS antigas com \n
  let alterou = false;
  data = data.map(rec => {
    if ((!rec.itens || !rec.itens.length) && typeof rec.texto === 'string' && rec.texto.includes('\\n')) {
      const novoTexto = rec.texto.replace(/\\n/g, '\n');
      alterou = true;
      return { ...rec, texto: novoTexto };
    }
    return rec;
  });
  if (alterou) localStorage.setItem('os_arquivadas', JSON.stringify(data));

  renderList();
}

load();
</script>

</body>
</html>    white-space:pre-wrap; word-break:break-word; line-height:1.2; margin:0;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1>OS Arquivadas</h1>
    <a class="link-top" href="menu.html">Voltar ao menu</a>
  </div>

  <div id="lista" class="list"></div>
</div>

<!-- Modal Detalhes -->
<div id="backdrop" class="backdrop">
  <div class="modal">
    <div class="modalhead">
      <div style="font-weight:800">Detalhes da OS</div>
      <button class="btn btn-outline" id="fechar">Fechar</button>
    </div>

    <div class="actions">
      <button class="btn btn-blue"  id="btnReprint">Reimprimir</button>
      <button class="btn btn-green" id="btnDuplicate">Duplicar p/ Vendas</button>
      <button class="btn btn-outline" id="btnEdit">Editar</button>
      <button class="btn btn-red"    id="btnDelete">Excluir</button>
    </div>

    <div class="preview-title">Pré-visualização (texto 80mm / 42 colunas)</div>
    <pre id="preview" class="preview"></pre>
  </div>
</div>

<script>
/* ========= helpers de formatação (mesmos de vendas) ========= */
const W = 42;
const money = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const pad2 = n => String(n).padStart(2,'0');
const padRight = (s,len)=>{ s=String(s||''); return s.length>len? s.slice(0,len): s + ' '.repeat(len-s.length); };
const center = (s,len)=>{ s=String(s||''); const L=Math.floor((len-s.length)/2); return ' '.repeat(L)+s+' '.repeat(len-s.length-L); };
function wrapLines(text, width){
  if (!text) return [];
  const words = String(text).split(/\s+/);
  const out = []; let line='';
  for (let w of words){
    if ((line + (line?' ':'') + w).length <= width) line += (line?' ':'') + w;
    else { if (line) out.push(line); while(w.length>width){ out.push(w.slice(0,width)); w=w.slice(width); } line=w; }
  }
  if (line) out.push(line);
  return out;
}

/* ------- gera a OS igual a vendas, a partir do registro salvo ------- */
function buildOSFromRecord(rec){
  const d = new Date(rec.createdAt || Date.now());
  const data = `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

  const cliente = (rec.cliente||'').toUpperCase();
  const placa   = (rec.placa||'').toUpperCase();
  const pedra   = (rec.pedra||'').toUpperCase();
  const obs     = (rec.obs||'').toUpperCase();
  const itens   = Array.isArray(rec.itens)? rec.itens : [];

  const out = [];
  out.push(center('IRMÃOS HARTMANN', W));
  out.push(center('ORDEM DE SERVIÇO', W));
  out.push('='.repeat(W));
  out.push(padRight(`DATA: ${data}`, W));
  out.push(padRight(`CLIENTE: ${cliente}`, W));
  out.push(padRight(`PLACA: ${placa}`, W));
  out.push(padRight(`PEDRA: ${pedra}`, W));
  out.push('-'.repeat(W));
  out.push(padRight('PRODUTO:', W));
  out.push('');

  if (obs){
    wrapLines('OBS: ' + obs, W).forEach(l => out.push(padRight(l,W)));
    out.push('');
  }

  let soma = 0;
  itens.forEach((it, idx)=>{
    const nome = (it.produto||'').toUpperCase();
    const tipo = it.tipo || 'CX';
    const qtd  = typeof it.qtd === 'number' ? it.qtd : parseFloat(it.qtd || 0);
    const unit = typeof it.unit === 'number'? it.unit: parseFloat(String(it.unit||'0').replace(',','.'));
    const subtotal = (qtd||0) * (unit||0);
    soma += subtotal;

    wrapLines(nome, W).forEach(l => out.push(padRight(l, W)));

    const esquerda = `QTD: ${String(qtd).replace('.',',')} ${tipo} R$ ${money(unit)}`;
    const direita  = `TOTAL: R$ ${money(subtotal)}`;
    const espacos  = W - esquerda.length - direita.length;
    out.push(esquerda + ' '.repeat(espacos>0?espacos:1) + direita);

    if (idx < itens.length-1) out.push('');
  });

  out.push('-'.repeat(W));
  const totalNota = `TOTAL DA NOTA: R$ ${money(soma)}`;
  out.push(' '.repeat(Math.max(0, W - totalNota.length)) + totalNota);
  out.push('');
  out.push('Assinatura: __________________________');

  return out.join('\n');
}

/* ================== carregar e listar ================== */
const listaEl = document.getElementById('lista');
let data = [];

function load(){
  try{ data = JSON.parse(localStorage.getItem('os_arquivadas')||'[]'); }
  catch{ data = []; }
  renderList();
}

function renderList(){
  listaEl.innerHTML = '';
  if (!data.length){
    const empty = document.createElement('div');
    empty.className='card';
    empty.textContent='Nenhuma OS arquivada ainda.';
    listaEl.appendChild(empty);
    return;
  }

  data
    .map((rec, idx)=>({ rec, idx }))
    .sort((a,b)=> (b.rec.createdAt||0) - (a.rec.createdAt||0))
    .forEach(({rec, idx})=>{
      const card = document.createElement('div');
      card.className = 'card';
      const total = Array.isArray(rec.itens) ? rec.itens.reduce((s,i)=> s + ( (parseFloat(i.qtd)||0) * (parseFloat(String(i.unit||'0').replace(',','.'))||0) ),0) : 0;

      card.innerHTML = `
        <div class="row">
          <div>
            <div style="font-weight:800">${(rec.cliente||'').toUpperCase()}</div>
            <div class="muted">${new Date(rec.createdAt||Date.now()).toLocaleString('pt-BR')}</div>
          </div>
          <div class="total">TOTAL: R$ ${money(total)}</div>
        </div>
      `;
      card.onclick = ()=> openModal(idx);
      listaEl.appendChild(card);
    });
}

/* ================== modal detalhes ================== */
const backdrop = document.getElementById('backdrop');
const preview  = document.getElementById('preview');
let currentIndex = -1;

function openModal(i){
  currentIndex = i;
  const rec = data[i];
  // gera a mesma OS de vendas:
  preview.textContent = buildOSFromRecord(rec);
  backdrop.style.display = 'flex';
}

document.getElementById('fechar').onclick = ()=> backdrop.style.display='none';

document.getElementById('btnReprint').onclick = async ()=>{
  if (currentIndex<0) return;
  const txt = buildOSFromRecord(data[currentIndex]);
  if (navigator.share){
    try{ await navigator.share({ text: txt, title:'OS Hartmann' }); }catch{}
  }else{
    try{ await navigator.clipboard.writeText(txt); alert('OS copiada! Abra o app da impressora e cole.'); }
    catch{ alert('Selecione e copie manualmente da prévia.'); }
  }
};

document.getElementById('btnDuplicate').onclick = ()=>{
  if (currentIndex<0) return;
  localStorage.setItem('draft_venda', JSON.stringify(data[currentIndex]));
  location.href = 'vendas.html';
};

document.getElementById('btnEdit').onclick = ()=>{
  if (currentIndex<0) return;
  // usa o mesmo fluxo de duplicar; em vendas você edita e reimprime
  localStorage.setItem('draft_venda', JSON.stringify(data[currentIndex]));
  location.href = 'vendas.html';
};

document.getElementById('btnDelete').onclick = ()=>{
  if (currentIndex<0) return;
  if (!confirm('Excluir esta OS arquivada?')) return;
  data.splice(currentIndex,1);
  localStorage.setItem('os_arquivadas', JSON.stringify(data));
  backdrop.style.display = 'none';
  renderList();
};

load();

/* ========= opcional: vendas.html pode ler esse rascunho =========
No início do vendas.html, você pode adicionar:

(() => {
  const raw = localStorage.getItem('draft_venda');
  if (!raw) return;
  const d = JSON.parse(raw);
  // preencher campos e itens...
  // depois: localStorage.removeItem('draft_venda');
})();
=============================================================== */
</script>
</body>
</html>  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    display:none; align-items:center; justify-content:center; padding:20px; z-index:20;
  }
  .modal{background:var(--card); border-radius:16px; max-width:760px; width:100%; max-height:92vh; overflow:auto; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.65);}
  .modal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
  .modal-title{font-weight:800; font-size:18px}
  .x{background:transparent; border:1px solid var(--border); color:var(--text); border-radius:10px; height:36px; padding:0 10px; cursor:pointer}
  label{font-size:14px;color:var(--muted);margin-top:8px;display:block}
  input,select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
    background:#0b1220;color:var(--text);margin-top:4px;margin-bottom:8px;text-transform:uppercase;
  }
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .grid4{display:grid; grid-template-columns:2fr .8fr .8fr .9fr; gap:8px}
  .item-row{display:flex; gap:8px; align-items:flex-end; margin-bottom:6px}
  .small{font-size:12px; color:var(--muted)}
  .sep{border-top:1px solid var(--border); margin:10px 0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="link-top" href="menu.html">Voltar ao menu</a>
    </div>

    <div class="title">OS Arquivadas</div>
    <div id="lista"></div>
  </div>

  <!-- Modal de Edição -->
  <div id="backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Editar OS arquivada</div>
        <button class="x" id="fecharModal">Fechar</button>
      </div>

      <div id="editForm">
        <div class="grid2">
          <div>
            <label>Cliente</label>
            <input id="e_cliente" type="text" placeholder="NOME DO CLIENTE">
          </div>
          <div>
            <label>Placa</label>
            <input id="e_placa" type="text" placeholder="ABC1D23">
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Pedra</label>
            <input id="e_pedra" type="number" inputmode="numeric" placeholder="07">
          </div>
          <div>
            <label>Observações</label>
            <input id="e_obs" type="text" placeholder="">
          </div>
        </div>

        <div class="sep"></div>
        <div class="small">Itens (produto, tipo, qtd, v.unit). Você pode adicionar/remover itens.</div>
        <div id="itensBox"></div>
        <button class="btn btn-outline" id="btnAddItem" type="button">+ Adicionar item</button>

        <div class="sep"></div>
        <div class="small">Pré-visualização (80mm / 42 colunas)</div>
        <pre id="e_preview" class="preview"></pre>

        <div class="rowBtns" style="margin-top:10px">
          <button class="btn btn-blue"  id="btnSalvar">Salvar alterações</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Utilidades compartilhadas ----------
  const $ = s => document.querySelector(s);
  const money = v => (isNaN(v)?0:v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const pad2 = n => String(n).padStart(2,'0');

  const W = 42;
  const padRight = (s,len)=>{ s=String(s||''); return s.length>len? s.slice(0,len): s + ' '.repeat(len-s.length); };
  const center = (s,len)=>{ s=String(s||''); const L=Math.floor((len-s.length)/2); return ' '.repeat(L)+s+' '.repeat(len-s.length-L); };

  function wrapLines(text, width){
    if (!text) return [];
    const words = String(text).split(/\s+/);
    const lines = []; let line='';
    words.forEach(w=>{
      if ((line + (line?' ':'') + w).length <= width) line += (line?' ':'') + w;
      else { if (line) lines.push(line); while(w.length>width){ lines.push(w.slice(0,width)); w=w.slice(width);} line=w; }
    });
    if (line) lines.push(line);
    return lines;
  }

  function normalizeText(t){
    return String(t || '')
      .replace(/\r\n/g, '\n')
      .replace(/\r/g, '\n')
      .replace(/\\n/g, '\n');
  }

  function parseNum(str){
    if (str === '' || str === null || str === undefined) return 0;
    return parseFloat(String(str).replace('.','').replace(',','.')) || 0;
  }

  // Monta OS no MESMO formato do vendas.html
  function buildOSFromData(data){
    const d = new Date(data.createdAt || Date.now());
    const dataStr = `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

    const cliente = (data.cliente||'').toUpperCase();
    const placa   = (data.placa||'').toUpperCase();
    const pedra   = (data.pedra||'').toUpperCase();
    const obs     = (data.obs||'').trim().toUpperCase();

    const out = [];
    out.push(center('IRMÃOS HARTMANN', W));
    out.push(center('ORDEM DE SERVIÇO', W));
    out.push('='.repeat(W));
    out.push(padRight(`DATA: ${dataStr}`, W));
    out.push(padRight(`CLIENTE: ${cliente}`, W));
    out.push(padRight(`PLACA: ${placa}`, W));
    out.push(padRight(`PEDRA: ${pedra}`, W));
    out.push('-'.repeat(W));
    out.push(padRight('PRODUTO:', W));
    out.push('');

    if (obs){
      wrapLines('OBS: ' + obs, W).forEach(l => out.push(padRight(l, W)));
      out.push('');
    }

    let soma = 0;
    (data.itens || []).forEach((it, idx)=>{
      const qtd  = parseNum(it.qtd);
      const unit = parseNum(it.unit);
      const subtotal = qtd * unit;
      soma += subtotal;

      wrapLines((it.produto||'').toUpperCase(), W).forEach(l => out.push(padRight(l, W)));

      const esquerda = `QTD: ${String(qtd).replace('.',',')} ${String(it.tipo||'').toUpperCase()} R$ ${money(unit)}`;
      const direita  = `TOTAL: R$ ${money(subtotal)}`;
      const espacos  = W - esquerda.length - direita.length;
      out.push(esquerda + ' '.repeat(espacos > 0 ? espacos : 1) + direita);

      if (idx < data.itens.length - 1) out.push('');
    });

    out.push('-'.repeat(W));
    const totalNota = `TOTAL DA NOTA: R$ ${money(soma)}`;
    out.push(' '.repeat(Math.max(0, W - totalNota.length)) + totalNota);
    out.push('');
    out.push('Assinatura: __________________________');

    return out.join('\n');
  }

  // ---------- Lista ----------
  function carregar(){
    let list = [];
    try { list = JSON.parse(localStorage.getItem('os_arquivadas') || '[]'); } catch(e){ list = []; }

    const cont = $('#lista');
    cont.innerHTML = '';

    if (!list.length){
      cont.innerHTML = '<div class="empty">Nenhuma OS arquivada ainda.</div>';
      return;
    }

    list
      .map((x,i)=>({idx:i, ...x}))
      .sort((a,b)=> b.createdAt - a.createdAt)
      .forEach(item=>{
        const card = document.createElement('div');
        card.className = 'card';

        const quando = item.createdAt ? new Date(item.createdAt) : null;
        const cab = document.createElement('div');
        cab.className = 'muted';
        cab.textContent =
          (quando ? `Salvo: ${quando.toLocaleDateString()} ${quando.toLocaleTimeString().slice(0,5)} • ` : '') +
          (item.cliente ? `Cliente: ${item.cliente.toUpperCase()}` : '');
        card.appendChild(cab);

        const pre = document.createElement('pre');
        pre.className = 'preview';
        pre.textContent = normalizeText(item.texto || buildOSFromData(item));
        card.appendChild(pre);

        const row = document.createElement('div');
        row.className = 'rowBtns';

        const btnPrint = document.createElement('button');
        btnPrint.className = 'btn btn-green';
        btnPrint.textContent = 'Imprimir';
        btnPrint.onclick = async ()=>{
          const texto = normalizeText(item.texto || buildOSFromData(item));
          if (navigator.share){
            try{ await navigator.share({ text: texto, title: 'OS Hartmann' }); }catch(e){}
          }else{
            try{ await navigator.clipboard.writeText(texto); alert('OS copiada! Abra o app da impressora e cole.'); }
            catch(e){ alert('Não foi possível copiar. Selecione o texto manualmente.'); }
          }
        };
        row.appendChild(btnPrint);

        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-blue';
        btnEdit.textContent = 'Editar';
        btnEdit.onclick = ()=> abrirEditor(item.idx);
        row.appendChild(btnEdit);

        const btnDel = document.createElement('button');
        btnDel.className = 'btn btn-orange';
        btnDel.textContent = 'Excluir';
        btnDel.onclick = ()=>{
          if (!confirm('Remover esta OS arquivada?')) return;
          let all = JSON.parse(localStorage.getItem('os_arquivadas') || '[]');
          all.splice(item.idx, 1);
          localStorage.setItem('os_arquivadas', JSON.stringify(all));
          carregar();
        };
        row.appendChild(btnDel);

        card.appendChild(row);

        cont.appendChild(card);
      });
  }

  // ---------- Editor (Modal) ----------
  let editIndex = null;
  function abrirEditor(idx){
    editIndex = idx;
    const all = JSON.parse(localStorage.getItem('os_arquivadas') || '[]');
    const it  = all[idx];

    $('#e_cliente').value = (it.cliente||'').toUpperCase();
    $('#e_placa').value   = (it.placa||'').toUpperCase();
    $('#e_pedra').value   = it.pedra || '';
    $('#e_obs').value     = (it.obs||'').toUpperCase();

    // monta itens
    const box = $('#itensBox');
    box.innerHTML = '';
    (it.itens||[]).forEach((obj,i)=> addItemRow(obj.produto||'', obj.tipo||'CX', obj.qtd||0, obj.unit||0));

    // prévia
    atualizarPreviewEditor();

    // abrir
    $('#backdrop').style.display = 'flex';
  }

  $('#fecharModal').onclick = ()=>{ $('#backdrop').style.display = 'none'; };

  function addItemRow(produto='', tipo='CX', qtd=0, unit=0){
    const row = document.createElement('div');
    row.className = 'item-row';

    const g = document.createElement('div');
    g.className = 'grid4';
    row.appendChild(g);

    const inpProd = document.createElement('input');
    inpProd.placeholder='PRODUTO';
    inpProd.value = String(produto).toUpperCase();
    g.appendChild(inpProd);

    const selTipo = document.createElement('select');
    selTipo.innerHTML = `<option value="CX">CX</option><option value="KG">KG</option>`;
    selTipo.value = String(tipo||'CX').toUpperCase();
    g.appendChild(selTipo);

    const inpQtd = document.createElement('input');
    inpQtd.type='number'; inpQtd.step='0.01'; inpQtd.inputMode='decimal';
    inpQtd.placeholder='QTD'; inpQtd.value= qtd;
    g.appendChild(inpQtd);

    const inpUnit = document.createElement('input');
    inpUnit.type='text'; inpUnit.inputMode='numeric'; inpUnit.placeholder='0,00';
    // máscara dinheiro
    inpUnit.value = (parseFloat(unit)||0).toFixed(2).replace('.',',');
    inpUnit.addEventListener('input', e=>{
      let val = e.target.value.replace(/\D/g, '');
      val = (parseInt(val || '0', 10) / 100).toFixed(2);
      e.target.value = val.replace('.', ',');
      atualizarPreviewEditor();
    });

    g.appendChild(inpUnit);

    const btnRem = document.createElement('button');
    btnRem.className='btn btn-outline';
    btnRem.textContent='Remover';
    btnRem.type='button';
    btnRem.onclick=()=>{ row.remove(); atualizarPreviewEditor(); };
    row.appendChild(btnRem);

    [inpProd, selTipo, inpQtd].forEach(el=>{
      el.addEventListener('input', ()=>{
        if (el === inpProd) el.value = el.value.toUpperCase();
        atualizarPreviewEditor();
      });
    });

    $('#itensBox').appendChild(row);
  }

  $('#btnAddItem').onclick = ()=> addItemRow('','CX',0,0);

  function coletarFormEditor(){
    const itens = [];
    document.querySelectorAll('#itensBox .item-row').forEach(r=>{
      const [prod, tipo, qtd, unit] = r.querySelectorAll('input,select');
      itens.push({
        produto: (prod.value||'').toUpperCase(),
        tipo: (tipo.value||'CX').toUpperCase(),
        qtd: parseNum(qtd.value),
        unit: parseNum(unit.value)
      });
    });

    return {
      cliente: ($('#e_cliente').value||'').toUpperCase(),
      placa: ($('#e_placa').value||'').toUpperCase(),
      pedra: ($('#e_pedra').value||''),
      obs: ($('#e_obs').value||'').toUpperCase(),
      itens
    };
  }

  function atualizarPreviewEditor(){
    const base = coletarFormEditor();
    base.createdAt = Date.now();
    $('#e_preview').textContent = buildOSFromData(base);
  }

  // Atualiza prévia quando campos do cabeçalho mudam
  ['e_cliente','e_placa','e_pedra','e_obs'].forEach(id=>{
    $('#'+id).addEventListener('input', e=>{
      if (id!=='e_pedra'){ // manter uppercase para textos
        const pos = e.target.selectionStart;
        e.target.value = e.target.value.toUpperCase();
        e.target.setSelectionRange(pos,pos);
      }
      atualizarPreviewEditor();
    });
  });

  $('#btnSalvar').onclick = ()=>{
    if (editIndex===null) return;
    const all = JSON.parse(localStorage.getItem('os_arquivadas') || '[]');
    const original = all[editIndex] || {};
    const novo = {...original, ...coletarFormEditor()};
    // Regenera o texto da OS
    novo.texto = buildOSFromData(novo);
    all[editIndex] = novo;
    localStorage.setItem('os_arquivadas', JSON.stringify(all));
    $('#backdrop').style.display = 'none';
    carregar();
  };

  carregar();
</script>
</body>
</html>







